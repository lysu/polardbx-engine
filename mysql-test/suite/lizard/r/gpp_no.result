###########################################
Test various types of gpp_no in gpp reads
###########################################
--------------------start DYNAMIC-----------------------------------------
CREATE PROCEDURE iterate_pages_in_space()
BEGIN
DECLARE v_iter INT DEFAULT 0;
DECLARE space_size INT DEFAULT 0;
SELECT FILE_SIZE/PAGE_SIZE INTO space_size FROM information_schema.INNODB_TABLESPACES WHERE NAME='test/t1';
SELECT 'Space size of test/t1:', space_size;
CALL dbms_stat.flush_gpp();
SET DEBUG='+d,set_gpp_enum_page_in_space';
WHILE v_iter < space_size + 3 DO
SET GLOBAL innodb_dbug_gpp_no = v_iter;
SELECT @@innodb_dbug_gpp_no;
SELECT id, c FROM t1 WHERE k = 4;
show status like '%scan_guess%';
SET v_iter = v_iter + 1;
END WHILE;
CALL dbms_stat.flush_gpp();
SET DEBUG='-d,set_gpp_enum_page_in_space';
END|
CREATE TABLE t1 ( id int NOT NULL, k int NOT NULL, c int NOT NULL, pad varchar(8192), PRIMARY KEY (id), KEY (k)) row_format=DYNAMIC engine=innodb;
set global innodb_lizard_stat_enabled=on;
set global innodb_purge_stop_now = on;
set global innodb_index_purge_guess_clust_enabled=on;
set global innodb_index_scan_guess_clust_enabled=on;
INSERT INTO t1 (id, k, c, pad) VALUES (1, 1, 1, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (2, 2, 2, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (3, 3, 3, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (4, 4, 4, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (5, 5, 5, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (6, 6, 6, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (7, 7, 7, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (8, 8, 8, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
select PAGE_NUMBER, PAGE_TYPE, TABLE_NAME, INDEX_NAME, NUMBER_RECORDS, DATA_SIZE from INFORMATION_SCHEMA.INNODB_BUFFER_PAGE WHERE TABLE_NAME like "%t1%" order by PAGE_NUMBER;
PAGE_NUMBER	PAGE_TYPE	TABLE_NAME	INDEX_NAME	NUMBER_RECORDS	DATA_SIZE
4	INDEX	`test`.`t1`	PRIMARY	4	56
5	INDEX	`test`.`t1`	k	8	136
6	INDEX	`test`.`t1`	PRIMARY	1	4057
7	INDEX	`test`.`t1`	PRIMARY	3	12171
8	INDEX	`test`.`t1`	PRIMARY	3	12171
9	INDEX	`test`.`t1`	PRIMARY	1	4057

=== Correct gpp ===
SELECT id, c FROM t1 WHERE k = 4;
id	c
4	4
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	0

=== FIL NULL ===
SET DEBUG='+d,set_gpp_null';
SELECT id, c FROM t1 WHERE k = 4;
id	c
4	4
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	1

=== Iterate pages in space  ===
CALL iterate_pages_in_space();
Space size of test/t1:	space_size
Space size of test/t1:	11
@@innodb_dbug_gpp_no
0
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	1
@@innodb_dbug_gpp_no
1
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	2
@@innodb_dbug_gpp_no
2
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	3
@@innodb_dbug_gpp_no
3
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	4
@@innodb_dbug_gpp_no
4
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	5
@@innodb_dbug_gpp_no
5
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	6
@@innodb_dbug_gpp_no
6
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	7
@@innodb_dbug_gpp_no
7
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	7
@@innodb_dbug_gpp_no
8
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	8
@@innodb_dbug_gpp_no
9
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	9
@@innodb_dbug_gpp_no
10
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	10
@@innodb_dbug_gpp_no
11
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	11
@@innodb_dbug_gpp_no
12
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	12
@@innodb_dbug_gpp_no
13
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	13

=== Freed page ===
set global innodb_purge_run_now = on;
start transaction;
DELETE FROM t1 WHERE k = 1;
DELETE FROM t1 WHERE k = 2;
DELETE FROM t1 WHERE k = 3;
commit;
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	3

The page (where page_no == 7), which originally contained the record with id = 4, has now been freed. 
select PAGE_NUMBER, PAGE_TYPE, TABLE_NAME, INDEX_NAME, NUMBER_RECORDS, DATA_SIZE from INFORMATION_SCHEMA.INNODB_BUFFER_PAGE WHERE TABLE_NAME like "%t1%" order by PAGE_NUMBER;
PAGE_NUMBER	PAGE_TYPE	TABLE_NAME	INDEX_NAME	NUMBER_RECORDS	DATA_SIZE
4	INDEX	`test`.`t1`	PRIMARY	2	28
5	INDEX	`test`.`t1`	k	5	85
8	INDEX	`test`.`t1`	PRIMARY	4	16228
9	INDEX	`test`.`t1`	PRIMARY	1	4057

Attempting to locate a clustered index record using an outdated gpp_no of a page that has already been freed.
SELECT id, c FROM t1 WHERE k = 4;
id	c
4	4
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	4
# Kill and restart
set global innodb_lizard_stat_enabled=on;
set global innodb_index_purge_guess_clust_enabled=on;
set global innodb_index_scan_guess_clust_enabled=on;

Re-examine the previously freed page following a server restart.
SELECT id, c FROM t1 WHERE k = 4;
id	c
4	4

=== Freed page in btr load ===
DELETE FROM t1 WHERE id < 8;
ALTER TABLE t1 DROP PRIMARY KEY, ADD PRIMARY KEY (c);

The page (where page_no == 6), previously allocated for a B-tree loading operation, has now been freed.
select PAGE_NUMBER, PAGE_TYPE, TABLE_NAME, INDEX_NAME, NUMBER_RECORDS from INFORMATION_SCHEMA.INNODB_BUFFER_PAGE 
where space = (select space from information_schema.innodb_indexes 
where table_id = (select table_id from information_schema.innodb_tables where name like '%t1%') limit 1) 
and page_type = 'index' and PAGE_NUMBER=6;
PAGE_NUMBER	PAGE_TYPE	TABLE_NAME	INDEX_NAME	NUMBER_RECORDS
6	INDEX	NULL	NULL	1
INSERT INTO t1 (id, k, c, pad) VALUES (1, 1, 1, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (2, 2, 2, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (3, 3, 3, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (4, 4, 4, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (5, 5, 5, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (6, 6, 6, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (7, 7, 7, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
CALL iterate_pages_in_space();
Space size of test/t1:	space_size
Space size of test/t1:	11
@@innodb_dbug_gpp_no
0
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	1
@@innodb_dbug_gpp_no
1
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	2
@@innodb_dbug_gpp_no
2
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	3
@@innodb_dbug_gpp_no
3
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	4
@@innodb_dbug_gpp_no
4
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	5
@@innodb_dbug_gpp_no
5
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	6
@@innodb_dbug_gpp_no
6
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	7
@@innodb_dbug_gpp_no
7
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	8
@@innodb_dbug_gpp_no
8
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	8
@@innodb_dbug_gpp_no
9
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	9
@@innodb_dbug_gpp_no
10
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	10
@@innodb_dbug_gpp_no
11
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	11
@@innodb_dbug_gpp_no
12
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	12
@@innodb_dbug_gpp_no
13
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	13

Attempting to locate a clustered index record using an outdated gpp_no of a page that has already been freed.
SET DEBUG='+d,set_gpp_enum_page_in_space';
SET GLOBAL innodb_dbug_gpp_no = 6;
SELECT @@innodb_dbug_gpp_no;
@@innodb_dbug_gpp_no
6
SELECT id, k FROM t1 WHERE k = 8;
id	k
8	8
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	1
# Kill and restart
set global innodb_lizard_stat_enabled=on;
set global innodb_index_purge_guess_clust_enabled=on;
set global innodb_index_scan_guess_clust_enabled=on;

Re-examine the previously freed page following a server restart.
SET DEBUG='+d,set_gpp_enum_page_in_space';
SET GLOBAL innodb_dbug_gpp_no = 6;
SELECT @@innodb_dbug_gpp_no;
@@innodb_dbug_gpp_no
6
SELECT id, k FROM t1 WHERE k = 8;
id	k
8	8
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	1

After the server restart, the page with page_no == 6 is now marked as allocated.
select PAGE_NUMBER, PAGE_TYPE, TABLE_NAME, INDEX_NAME, NUMBER_RECORDS, DATA_SIZE from INFORMATION_SCHEMA.INNODB_BUFFER_PAGE 
where space = (select space from information_schema.innodb_indexes 
where table_id = (select table_id from information_schema.innodb_tables where name like '%t1%') limit 1) 
and (page_type = 'index' or page_number=6) order by PAGE_NUMBER;
PAGE_NUMBER	PAGE_TYPE	TABLE_NAME	INDEX_NAME	NUMBER_RECORDS	DATA_SIZE
4	INDEX	`test`.`t1`	PRIMARY	4	56
5	INDEX	`test`.`t1`	k	8	136
6	INDEX	`test`.`t1`	PRIMARY	1	4057
9	INDEX	`test`.`t1`	PRIMARY	3	12171
CALL iterate_pages_in_space();
Space size of test/t1:	space_size
Space size of test/t1:	11
@@innodb_dbug_gpp_no
0
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	1
@@innodb_dbug_gpp_no
1
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	2
@@innodb_dbug_gpp_no
2
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	3
@@innodb_dbug_gpp_no
3
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	4
@@innodb_dbug_gpp_no
4
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	5
@@innodb_dbug_gpp_no
5
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	6
@@innodb_dbug_gpp_no
6
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	7
@@innodb_dbug_gpp_no
7
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	8
@@innodb_dbug_gpp_no
8
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	8
@@innodb_dbug_gpp_no
9
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	9
@@innodb_dbug_gpp_no
10
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	10
@@innodb_dbug_gpp_no
11
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	11
@@innodb_dbug_gpp_no
12
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	12
@@innodb_dbug_gpp_no
13
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	13

# Set gpp_no to a large number which is out of tablespace.
SET DEBUG='+d,set_gpp_enum_page_in_space';
SET GLOBAL innodb_dbug_gpp_no = 999999;
SELECT @@innodb_dbug_gpp_no;
@@innodb_dbug_gpp_no
999999
SET DEBUG_SYNC = 'gpp_ignore_missing_before_free_page SIGNAL s1 WAIT_FOR s2';
SELECT id, k FROM t1 WHERE k = 8;;
SET DEBUG='+d,set_gpp_enum_page_in_space';
SET DEBUG_SYNC = 'now WAIT_FOR s1';
SET DEBUG_SYNC = 'gpp_hit_io_fix_read SIGNAL s2';
SELECT id, k FROM t1 WHERE k = 8;
id	k
8	8
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	2
id	k
8	8
SET DEBUG='+d,set_gpp_enum_page_in_space';
SET GLOBAL innodb_dbug_gpp_no = 999999;
SELECT @@innodb_dbug_gpp_no;
@@innodb_dbug_gpp_no
999999
SET DEBUG_SYNC = 'gpp_ignore_missing_after_free_page SIGNAL s1 WAIT_FOR s2';
SELECT id, k FROM t1 WHERE k = 8;;
SET DEBUG='+d,set_gpp_enum_page_in_space';
SET DEBUG_SYNC = 'now WAIT_FOR s1';
SELECT id, k FROM t1 WHERE k = 8;
id	k
8	8
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	3
SET DEBUG_SYNC = 'now signal s2';
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	4
id	k
8	8
drop table t1;
set global innodb_lizard_stat_enabled = default;
set global innodb_purge_stop_now = default;
set global innodb_purge_run_now = default;
set global innodb_dbug_gpp_no = default;
drop procedure iterate_pages_in_space;
# Kill and restart
--------------------start COMPRESSED-----------------------------------------
CREATE PROCEDURE iterate_pages_in_space()
BEGIN
DECLARE v_iter INT DEFAULT 0;
DECLARE space_size INT DEFAULT 0;
SELECT FILE_SIZE/PAGE_SIZE INTO space_size FROM information_schema.INNODB_TABLESPACES WHERE NAME='test/t1';
SELECT 'Space size of test/t1:', space_size;
CALL dbms_stat.flush_gpp();
SET DEBUG='+d,set_gpp_enum_page_in_space';
WHILE v_iter < space_size + 3 DO
SET GLOBAL innodb_dbug_gpp_no = v_iter;
SELECT @@innodb_dbug_gpp_no;
SELECT id, c FROM t1 WHERE k = 4;
show status like '%scan_guess%';
SET v_iter = v_iter + 1;
END WHILE;
CALL dbms_stat.flush_gpp();
SET DEBUG='-d,set_gpp_enum_page_in_space';
END|
CREATE TABLE t1 ( id int NOT NULL, k int NOT NULL, c int NOT NULL, pad varchar(8192), PRIMARY KEY (id), KEY (k)) row_format=COMPRESSED engine=innodb;
set global innodb_lizard_stat_enabled=on;
set global innodb_purge_stop_now = on;
set global innodb_index_purge_guess_clust_enabled=on;
set global innodb_index_scan_guess_clust_enabled=on;
INSERT INTO t1 (id, k, c, pad) VALUES (1, 1, 1, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (2, 2, 2, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (3, 3, 3, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (4, 4, 4, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (5, 5, 5, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (6, 6, 6, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (7, 7, 7, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (8, 8, 8, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
select PAGE_NUMBER, PAGE_TYPE, TABLE_NAME, INDEX_NAME, NUMBER_RECORDS, DATA_SIZE from INFORMATION_SCHEMA.INNODB_BUFFER_PAGE WHERE TABLE_NAME like "%t1%" order by PAGE_NUMBER;
PAGE_NUMBER	PAGE_TYPE	TABLE_NAME	INDEX_NAME	NUMBER_RECORDS	DATA_SIZE
4	INDEX	`test`.`t1`	PRIMARY	3	42
5	INDEX	`test`.`t1`	k	8	104
6	INDEX	`test`.`t1`	PRIMARY	2	8114
7	INDEX	`test`.`t1`	PRIMARY	4	16228
8	INDEX	`test`.`t1`	PRIMARY	2	8114

=== Correct gpp ===
SELECT id, c FROM t1 WHERE k = 4;
id	c
4	4
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0

=== FIL NULL ===
SET DEBUG='+d,set_gpp_null';
SELECT id, c FROM t1 WHERE k = 4;
id	c
4	4
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0

=== Iterate pages in space  ===
CALL iterate_pages_in_space();
Space size of test/t1:	space_size
Space size of test/t1:	5
@@innodb_dbug_gpp_no
0
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
@@innodb_dbug_gpp_no
1
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
@@innodb_dbug_gpp_no
2
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
@@innodb_dbug_gpp_no
3
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
@@innodb_dbug_gpp_no
4
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
@@innodb_dbug_gpp_no
5
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
@@innodb_dbug_gpp_no
6
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
@@innodb_dbug_gpp_no
7
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0

=== Freed page ===
set global innodb_purge_run_now = on;
start transaction;
DELETE FROM t1 WHERE k = 1;
DELETE FROM t1 WHERE k = 2;
DELETE FROM t1 WHERE k = 3;
commit;
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0

The page (where page_no == 7), which originally contained the record with id = 4, has now been freed. 
select PAGE_NUMBER, PAGE_TYPE, TABLE_NAME, INDEX_NAME, NUMBER_RECORDS, DATA_SIZE from INFORMATION_SCHEMA.INNODB_BUFFER_PAGE WHERE TABLE_NAME like "%t1%" order by PAGE_NUMBER;
PAGE_NUMBER	PAGE_TYPE	TABLE_NAME	INDEX_NAME	NUMBER_RECORDS	DATA_SIZE
4	INDEX	`test`.`t1`	PRIMARY	2	28
5	INDEX	`test`.`t1`	k	5	65
7	INDEX	`test`.`t1`	PRIMARY	3	12171
8	INDEX	`test`.`t1`	PRIMARY	2	8114

Attempting to locate a clustered index record using an outdated gpp_no of a page that has already been freed.
SELECT id, c FROM t1 WHERE k = 4;
id	c
4	4
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
# Kill and restart
set global innodb_lizard_stat_enabled=on;
set global innodb_index_purge_guess_clust_enabled=on;
set global innodb_index_scan_guess_clust_enabled=on;

Re-examine the previously freed page following a server restart.
SELECT id, c FROM t1 WHERE k = 4;
id	c
4	4

=== Freed page in btr load ===
DELETE FROM t1 WHERE id < 8;
ALTER TABLE t1 DROP PRIMARY KEY, ADD PRIMARY KEY (c);

The page (where page_no == 6), previously allocated for a B-tree loading operation, has now been freed.
select PAGE_NUMBER, PAGE_TYPE, TABLE_NAME, INDEX_NAME, NUMBER_RECORDS from INFORMATION_SCHEMA.INNODB_BUFFER_PAGE 
where space = (select space from information_schema.innodb_indexes 
where table_id = (select table_id from information_schema.innodb_tables where name like '%t1%') limit 1) 
and page_type = 'index' and PAGE_NUMBER=6;
PAGE_NUMBER	PAGE_TYPE	TABLE_NAME	INDEX_NAME	NUMBER_RECORDS
6	INDEX	NULL	NULL	1
INSERT INTO t1 (id, k, c, pad) VALUES (1, 1, 1, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (2, 2, 2, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (3, 3, 3, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (4, 4, 4, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (5, 5, 5, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (6, 6, 6, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (7, 7, 7, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
CALL iterate_pages_in_space();
Space size of test/t1:	space_size
Space size of test/t1:	5
@@innodb_dbug_gpp_no
0
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
@@innodb_dbug_gpp_no
1
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
@@innodb_dbug_gpp_no
2
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
@@innodb_dbug_gpp_no
3
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
@@innodb_dbug_gpp_no
4
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
@@innodb_dbug_gpp_no
5
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
@@innodb_dbug_gpp_no
6
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
@@innodb_dbug_gpp_no
7
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0

Attempting to locate a clustered index record using an outdated gpp_no of a page that has already been freed.
SET DEBUG='+d,set_gpp_enum_page_in_space';
SET GLOBAL innodb_dbug_gpp_no = 6;
SELECT @@innodb_dbug_gpp_no;
@@innodb_dbug_gpp_no
6
SELECT id, k FROM t1 WHERE k = 8;
id	k
8	8
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
# Kill and restart
set global innodb_lizard_stat_enabled=on;
set global innodb_index_purge_guess_clust_enabled=on;
set global innodb_index_scan_guess_clust_enabled=on;

Re-examine the previously freed page following a server restart.
SET DEBUG='+d,set_gpp_enum_page_in_space';
SET GLOBAL innodb_dbug_gpp_no = 6;
SELECT @@innodb_dbug_gpp_no;
@@innodb_dbug_gpp_no
6
SELECT id, k FROM t1 WHERE k = 8;
id	k
8	8
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0

After the server restart, the page with page_no == 6 is now marked as allocated.
select PAGE_NUMBER, PAGE_TYPE, TABLE_NAME, INDEX_NAME, NUMBER_RECORDS, DATA_SIZE from INFORMATION_SCHEMA.INNODB_BUFFER_PAGE 
where space = (select space from information_schema.innodb_indexes 
where table_id = (select table_id from information_schema.innodb_tables where name like '%t1%') limit 1) 
and (page_type = 'index' or page_number=6) order by PAGE_NUMBER;
PAGE_NUMBER	PAGE_TYPE	TABLE_NAME	INDEX_NAME	NUMBER_RECORDS	DATA_SIZE
4	INDEX	`test`.`t1`	PRIMARY	3	42
5	INDEX	`test`.`t1`	k	8	104
7	INDEX	`test`.`t1`	PRIMARY	4	16228
CALL iterate_pages_in_space();
Space size of test/t1:	space_size
Space size of test/t1:	5
@@innodb_dbug_gpp_no
0
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
@@innodb_dbug_gpp_no
1
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
@@innodb_dbug_gpp_no
2
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
@@innodb_dbug_gpp_no
3
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
@@innodb_dbug_gpp_no
4
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
@@innodb_dbug_gpp_no
5
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
@@innodb_dbug_gpp_no
6
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
@@innodb_dbug_gpp_no
7
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	0
drop table t1;
set global innodb_lizard_stat_enabled = default;
set global innodb_purge_stop_now = default;
set global innodb_purge_run_now = default;
set global innodb_dbug_gpp_no = default;
drop procedure iterate_pages_in_space;
# Kill and restart
--------------------start REDUNDANT-----------------------------------------
CREATE PROCEDURE iterate_pages_in_space()
BEGIN
DECLARE v_iter INT DEFAULT 0;
DECLARE space_size INT DEFAULT 0;
SELECT FILE_SIZE/PAGE_SIZE INTO space_size FROM information_schema.INNODB_TABLESPACES WHERE NAME='test/t1';
SELECT 'Space size of test/t1:', space_size;
CALL dbms_stat.flush_gpp();
SET DEBUG='+d,set_gpp_enum_page_in_space';
WHILE v_iter < space_size + 3 DO
SET GLOBAL innodb_dbug_gpp_no = v_iter;
SELECT @@innodb_dbug_gpp_no;
SELECT id, c FROM t1 WHERE k = 4;
show status like '%scan_guess%';
SET v_iter = v_iter + 1;
END WHILE;
CALL dbms_stat.flush_gpp();
SET DEBUG='-d,set_gpp_enum_page_in_space';
END|
CREATE TABLE t1 ( id int NOT NULL, k int NOT NULL, c int NOT NULL, pad varchar(8192), PRIMARY KEY (id), KEY (k)) row_format=REDUNDANT engine=innodb;
set global innodb_lizard_stat_enabled=on;
set global innodb_purge_stop_now = on;
set global innodb_index_purge_guess_clust_enabled=on;
set global innodb_index_scan_guess_clust_enabled=on;
INSERT INTO t1 (id, k, c, pad) VALUES (1, 1, 1, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (2, 2, 2, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (3, 3, 3, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (4, 4, 4, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (5, 5, 5, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (6, 6, 6, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (7, 7, 7, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (8, 8, 8, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
select PAGE_NUMBER, PAGE_TYPE, TABLE_NAME, INDEX_NAME, NUMBER_RECORDS, DATA_SIZE from INFORMATION_SCHEMA.INNODB_BUFFER_PAGE WHERE TABLE_NAME like "%t1%" order by PAGE_NUMBER;
PAGE_NUMBER	PAGE_TYPE	TABLE_NAME	INDEX_NAME	NUMBER_RECORDS	DATA_SIZE
4	INDEX	`test`.`t1`	PRIMARY	4	64
5	INDEX	`test`.`t1`	k	8	168
6	INDEX	`test`.`t1`	PRIMARY	1	4073
7	INDEX	`test`.`t1`	PRIMARY	3	12219
8	INDEX	`test`.`t1`	PRIMARY	3	12219
9	INDEX	`test`.`t1`	PRIMARY	1	4073

=== Correct gpp ===
SELECT id, c FROM t1 WHERE k = 4;
id	c
4	4
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	0

=== FIL NULL ===
SET DEBUG='+d,set_gpp_null';
SELECT id, c FROM t1 WHERE k = 4;
id	c
4	4
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	1

=== Iterate pages in space  ===
CALL iterate_pages_in_space();
Space size of test/t1:	space_size
Space size of test/t1:	11
@@innodb_dbug_gpp_no
0
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	1
@@innodb_dbug_gpp_no
1
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	2
@@innodb_dbug_gpp_no
2
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	3
@@innodb_dbug_gpp_no
3
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	4
@@innodb_dbug_gpp_no
4
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	5
@@innodb_dbug_gpp_no
5
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	6
@@innodb_dbug_gpp_no
6
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	7
@@innodb_dbug_gpp_no
7
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	7
@@innodb_dbug_gpp_no
8
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	8
@@innodb_dbug_gpp_no
9
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	9
@@innodb_dbug_gpp_no
10
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	10
@@innodb_dbug_gpp_no
11
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	11
@@innodb_dbug_gpp_no
12
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	12
@@innodb_dbug_gpp_no
13
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	13

=== Freed page ===
set global innodb_purge_run_now = on;
start transaction;
DELETE FROM t1 WHERE k = 1;
DELETE FROM t1 WHERE k = 2;
DELETE FROM t1 WHERE k = 3;
commit;
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	3

The page (where page_no == 7), which originally contained the record with id = 4, has now been freed. 
select PAGE_NUMBER, PAGE_TYPE, TABLE_NAME, INDEX_NAME, NUMBER_RECORDS, DATA_SIZE from INFORMATION_SCHEMA.INNODB_BUFFER_PAGE WHERE TABLE_NAME like "%t1%" order by PAGE_NUMBER;
PAGE_NUMBER	PAGE_TYPE	TABLE_NAME	INDEX_NAME	NUMBER_RECORDS	DATA_SIZE
4	INDEX	`test`.`t1`	PRIMARY	3	48
5	INDEX	`test`.`t1`	k	5	105
7	INDEX	`test`.`t1`	PRIMARY	1	4073
8	INDEX	`test`.`t1`	PRIMARY	3	12219
9	INDEX	`test`.`t1`	PRIMARY	1	4073

Attempting to locate a clustered index record using an outdated gpp_no of a page that has already been freed.
SELECT id, c FROM t1 WHERE k = 4;
id	c
4	4
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	3
# Kill and restart
set global innodb_lizard_stat_enabled=on;
set global innodb_index_purge_guess_clust_enabled=on;
set global innodb_index_scan_guess_clust_enabled=on;

Re-examine the previously freed page following a server restart.
SELECT id, c FROM t1 WHERE k = 4;
id	c
4	4

=== Freed page in btr load ===
DELETE FROM t1 WHERE id < 8;
ALTER TABLE t1 DROP PRIMARY KEY, ADD PRIMARY KEY (c);

The page (where page_no == 6), previously allocated for a B-tree loading operation, has now been freed.
select PAGE_NUMBER, PAGE_TYPE, TABLE_NAME, INDEX_NAME, NUMBER_RECORDS from INFORMATION_SCHEMA.INNODB_BUFFER_PAGE 
where space = (select space from information_schema.innodb_indexes 
where table_id = (select table_id from information_schema.innodb_tables where name like '%t1%') limit 1) 
and page_type = 'index' and PAGE_NUMBER=6;
PAGE_NUMBER	PAGE_TYPE	TABLE_NAME	INDEX_NAME	NUMBER_RECORDS
6	INDEX	NULL	NULL	1
INSERT INTO t1 (id, k, c, pad) VALUES (1, 1, 1, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (2, 2, 2, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (3, 3, 3, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (4, 4, 4, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (5, 5, 5, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (6, 6, 6, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (7, 7, 7, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
CALL iterate_pages_in_space();
Space size of test/t1:	space_size
Space size of test/t1:	11
@@innodb_dbug_gpp_no
0
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	1
@@innodb_dbug_gpp_no
1
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	2
@@innodb_dbug_gpp_no
2
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	3
@@innodb_dbug_gpp_no
3
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	4
@@innodb_dbug_gpp_no
4
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	5
@@innodb_dbug_gpp_no
5
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	6
@@innodb_dbug_gpp_no
6
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	7
@@innodb_dbug_gpp_no
7
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	8
@@innodb_dbug_gpp_no
8
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	8
@@innodb_dbug_gpp_no
9
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	9
@@innodb_dbug_gpp_no
10
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	10
@@innodb_dbug_gpp_no
11
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	11
@@innodb_dbug_gpp_no
12
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	12
@@innodb_dbug_gpp_no
13
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	13

Attempting to locate a clustered index record using an outdated gpp_no of a page that has already been freed.
SET DEBUG='+d,set_gpp_enum_page_in_space';
SET GLOBAL innodb_dbug_gpp_no = 6;
SELECT @@innodb_dbug_gpp_no;
@@innodb_dbug_gpp_no
6
SELECT id, k FROM t1 WHERE k = 8;
id	k
8	8
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	1
# Kill and restart
set global innodb_lizard_stat_enabled=on;
set global innodb_index_purge_guess_clust_enabled=on;
set global innodb_index_scan_guess_clust_enabled=on;

Re-examine the previously freed page following a server restart.
SET DEBUG='+d,set_gpp_enum_page_in_space';
SET GLOBAL innodb_dbug_gpp_no = 6;
SELECT @@innodb_dbug_gpp_no;
@@innodb_dbug_gpp_no
6
SELECT id, k FROM t1 WHERE k = 8;
id	k
8	8
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	1

After the server restart, the page with page_no == 6 is now marked as allocated.
select PAGE_NUMBER, PAGE_TYPE, TABLE_NAME, INDEX_NAME, NUMBER_RECORDS, DATA_SIZE from INFORMATION_SCHEMA.INNODB_BUFFER_PAGE 
where space = (select space from information_schema.innodb_indexes 
where table_id = (select table_id from information_schema.innodb_tables where name like '%t1%') limit 1) 
and (page_type = 'index' or page_number=6) order by PAGE_NUMBER;
PAGE_NUMBER	PAGE_TYPE	TABLE_NAME	INDEX_NAME	NUMBER_RECORDS	DATA_SIZE
4	INDEX	`test`.`t1`	PRIMARY	4	64
5	INDEX	`test`.`t1`	k	8	168
6	INDEX	`test`.`t1`	PRIMARY	1	4073
9	INDEX	`test`.`t1`	PRIMARY	3	12219
CALL iterate_pages_in_space();
Space size of test/t1:	space_size
Space size of test/t1:	11
@@innodb_dbug_gpp_no
0
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	1
@@innodb_dbug_gpp_no
1
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	2
@@innodb_dbug_gpp_no
2
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	3
@@innodb_dbug_gpp_no
3
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	4
@@innodb_dbug_gpp_no
4
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	5
@@innodb_dbug_gpp_no
5
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	6
@@innodb_dbug_gpp_no
6
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	7
@@innodb_dbug_gpp_no
7
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	8
@@innodb_dbug_gpp_no
8
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	8
@@innodb_dbug_gpp_no
9
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	9
@@innodb_dbug_gpp_no
10
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	10
@@innodb_dbug_gpp_no
11
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	11
@@innodb_dbug_gpp_no
12
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	12
@@innodb_dbug_gpp_no
13
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	13

# Set gpp_no to a large number which is out of tablespace.
SET DEBUG='+d,set_gpp_enum_page_in_space';
SET GLOBAL innodb_dbug_gpp_no = 999999;
SELECT @@innodb_dbug_gpp_no;
@@innodb_dbug_gpp_no
999999
SET DEBUG_SYNC = 'gpp_ignore_missing_before_free_page SIGNAL s1 WAIT_FOR s2';
SELECT id, k FROM t1 WHERE k = 8;;
SET DEBUG='+d,set_gpp_enum_page_in_space';
SET DEBUG_SYNC = 'now WAIT_FOR s1';
SET DEBUG_SYNC = 'gpp_hit_io_fix_read SIGNAL s2';
SELECT id, k FROM t1 WHERE k = 8;
id	k
8	8
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	2
id	k
8	8
SET DEBUG='+d,set_gpp_enum_page_in_space';
SET GLOBAL innodb_dbug_gpp_no = 999999;
SELECT @@innodb_dbug_gpp_no;
@@innodb_dbug_gpp_no
999999
SET DEBUG_SYNC = 'gpp_ignore_missing_after_free_page SIGNAL s1 WAIT_FOR s2';
SELECT id, k FROM t1 WHERE k = 8;;
SET DEBUG='+d,set_gpp_enum_page_in_space';
SET DEBUG_SYNC = 'now WAIT_FOR s1';
SELECT id, k FROM t1 WHERE k = 8;
id	k
8	8
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	3
SET DEBUG_SYNC = 'now signal s2';
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	4
id	k
8	8
drop table t1;
set global innodb_lizard_stat_enabled = default;
set global innodb_purge_stop_now = default;
set global innodb_purge_run_now = default;
set global innodb_dbug_gpp_no = default;
drop procedure iterate_pages_in_space;
# Kill and restart
--------------------start COMPACT-----------------------------------------
CREATE PROCEDURE iterate_pages_in_space()
BEGIN
DECLARE v_iter INT DEFAULT 0;
DECLARE space_size INT DEFAULT 0;
SELECT FILE_SIZE/PAGE_SIZE INTO space_size FROM information_schema.INNODB_TABLESPACES WHERE NAME='test/t1';
SELECT 'Space size of test/t1:', space_size;
CALL dbms_stat.flush_gpp();
SET DEBUG='+d,set_gpp_enum_page_in_space';
WHILE v_iter < space_size + 3 DO
SET GLOBAL innodb_dbug_gpp_no = v_iter;
SELECT @@innodb_dbug_gpp_no;
SELECT id, c FROM t1 WHERE k = 4;
show status like '%scan_guess%';
SET v_iter = v_iter + 1;
END WHILE;
CALL dbms_stat.flush_gpp();
SET DEBUG='-d,set_gpp_enum_page_in_space';
END|
CREATE TABLE t1 ( id int NOT NULL, k int NOT NULL, c int NOT NULL, pad varchar(8192), PRIMARY KEY (id), KEY (k)) row_format=COMPACT engine=innodb;
set global innodb_lizard_stat_enabled=on;
set global innodb_purge_stop_now = on;
set global innodb_index_purge_guess_clust_enabled=on;
set global innodb_index_scan_guess_clust_enabled=on;
INSERT INTO t1 (id, k, c, pad) VALUES (1, 1, 1, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (2, 2, 2, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (3, 3, 3, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (4, 4, 4, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (5, 5, 5, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (6, 6, 6, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (7, 7, 7, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (8, 8, 8, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
select PAGE_NUMBER, PAGE_TYPE, TABLE_NAME, INDEX_NAME, NUMBER_RECORDS, DATA_SIZE from INFORMATION_SCHEMA.INNODB_BUFFER_PAGE WHERE TABLE_NAME like "%t1%" order by PAGE_NUMBER;
PAGE_NUMBER	PAGE_TYPE	TABLE_NAME	INDEX_NAME	NUMBER_RECORDS	DATA_SIZE
4	INDEX	`test`.`t1`	PRIMARY	4	56
5	INDEX	`test`.`t1`	k	8	136
6	INDEX	`test`.`t1`	PRIMARY	1	4057
7	INDEX	`test`.`t1`	PRIMARY	3	12171
8	INDEX	`test`.`t1`	PRIMARY	3	12171
9	INDEX	`test`.`t1`	PRIMARY	1	4057

=== Correct gpp ===
SELECT id, c FROM t1 WHERE k = 4;
id	c
4	4
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	0

=== FIL NULL ===
SET DEBUG='+d,set_gpp_null';
SELECT id, c FROM t1 WHERE k = 4;
id	c
4	4
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	1

=== Iterate pages in space  ===
CALL iterate_pages_in_space();
Space size of test/t1:	space_size
Space size of test/t1:	11
@@innodb_dbug_gpp_no
0
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	1
@@innodb_dbug_gpp_no
1
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	2
@@innodb_dbug_gpp_no
2
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	3
@@innodb_dbug_gpp_no
3
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	4
@@innodb_dbug_gpp_no
4
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	5
@@innodb_dbug_gpp_no
5
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	6
@@innodb_dbug_gpp_no
6
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	7
@@innodb_dbug_gpp_no
7
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	7
@@innodb_dbug_gpp_no
8
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	8
@@innodb_dbug_gpp_no
9
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	9
@@innodb_dbug_gpp_no
10
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	10
@@innodb_dbug_gpp_no
11
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	11
@@innodb_dbug_gpp_no
12
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	12
@@innodb_dbug_gpp_no
13
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	13

=== Freed page ===
set global innodb_purge_run_now = on;
start transaction;
DELETE FROM t1 WHERE k = 1;
DELETE FROM t1 WHERE k = 2;
DELETE FROM t1 WHERE k = 3;
commit;
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	3

The page (where page_no == 7), which originally contained the record with id = 4, has now been freed. 
select PAGE_NUMBER, PAGE_TYPE, TABLE_NAME, INDEX_NAME, NUMBER_RECORDS, DATA_SIZE from INFORMATION_SCHEMA.INNODB_BUFFER_PAGE WHERE TABLE_NAME like "%t1%" order by PAGE_NUMBER;
PAGE_NUMBER	PAGE_TYPE	TABLE_NAME	INDEX_NAME	NUMBER_RECORDS	DATA_SIZE
4	INDEX	`test`.`t1`	PRIMARY	2	28
5	INDEX	`test`.`t1`	k	5	85
8	INDEX	`test`.`t1`	PRIMARY	4	16228
9	INDEX	`test`.`t1`	PRIMARY	1	4057

Attempting to locate a clustered index record using an outdated gpp_no of a page that has already been freed.
SELECT id, c FROM t1 WHERE k = 4;
id	c
4	4
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	4
# Kill and restart
set global innodb_lizard_stat_enabled=on;
set global innodb_index_purge_guess_clust_enabled=on;
set global innodb_index_scan_guess_clust_enabled=on;

Re-examine the previously freed page following a server restart.
SELECT id, c FROM t1 WHERE k = 4;
id	c
4	4

=== Freed page in btr load ===
DELETE FROM t1 WHERE id < 8;
ALTER TABLE t1 DROP PRIMARY KEY, ADD PRIMARY KEY (c);

The page (where page_no == 6), previously allocated for a B-tree loading operation, has now been freed.
select PAGE_NUMBER, PAGE_TYPE, TABLE_NAME, INDEX_NAME, NUMBER_RECORDS from INFORMATION_SCHEMA.INNODB_BUFFER_PAGE 
where space = (select space from information_schema.innodb_indexes 
where table_id = (select table_id from information_schema.innodb_tables where name like '%t1%') limit 1) 
and page_type = 'index' and PAGE_NUMBER=6;
PAGE_NUMBER	PAGE_TYPE	TABLE_NAME	INDEX_NAME	NUMBER_RECORDS
6	INDEX	NULL	NULL	1
INSERT INTO t1 (id, k, c, pad) VALUES (1, 1, 1, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (2, 2, 2, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (3, 3, 3, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (4, 4, 4, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (5, 5, 5, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (6, 6, 6, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
INSERT INTO t1 (id, k, c, pad) VALUES (7, 7, 7, LEFT(REPEAT('A', 4000), CHAR_LENGTH(REPEAT('A', 4000))));
CALL iterate_pages_in_space();
Space size of test/t1:	space_size
Space size of test/t1:	11
@@innodb_dbug_gpp_no
0
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	1
@@innodb_dbug_gpp_no
1
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	2
@@innodb_dbug_gpp_no
2
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	3
@@innodb_dbug_gpp_no
3
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	4
@@innodb_dbug_gpp_no
4
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	5
@@innodb_dbug_gpp_no
5
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	6
@@innodb_dbug_gpp_no
6
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	7
@@innodb_dbug_gpp_no
7
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	8
@@innodb_dbug_gpp_no
8
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	8
@@innodb_dbug_gpp_no
9
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	9
@@innodb_dbug_gpp_no
10
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	10
@@innodb_dbug_gpp_no
11
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	11
@@innodb_dbug_gpp_no
12
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	12
@@innodb_dbug_gpp_no
13
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	13

Attempting to locate a clustered index record using an outdated gpp_no of a page that has already been freed.
SET DEBUG='+d,set_gpp_enum_page_in_space';
SET GLOBAL innodb_dbug_gpp_no = 6;
SELECT @@innodb_dbug_gpp_no;
@@innodb_dbug_gpp_no
6
SELECT id, k FROM t1 WHERE k = 8;
id	k
8	8
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	1
# Kill and restart
set global innodb_lizard_stat_enabled=on;
set global innodb_index_purge_guess_clust_enabled=on;
set global innodb_index_scan_guess_clust_enabled=on;

Re-examine the previously freed page following a server restart.
SET DEBUG='+d,set_gpp_enum_page_in_space';
SET GLOBAL innodb_dbug_gpp_no = 6;
SELECT @@innodb_dbug_gpp_no;
@@innodb_dbug_gpp_no
6
SELECT id, k FROM t1 WHERE k = 8;
id	k
8	8
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	1

After the server restart, the page with page_no == 6 is now marked as allocated.
select PAGE_NUMBER, PAGE_TYPE, TABLE_NAME, INDEX_NAME, NUMBER_RECORDS, DATA_SIZE from INFORMATION_SCHEMA.INNODB_BUFFER_PAGE 
where space = (select space from information_schema.innodb_indexes 
where table_id = (select table_id from information_schema.innodb_tables where name like '%t1%') limit 1) 
and (page_type = 'index' or page_number=6) order by PAGE_NUMBER;
PAGE_NUMBER	PAGE_TYPE	TABLE_NAME	INDEX_NAME	NUMBER_RECORDS	DATA_SIZE
4	INDEX	`test`.`t1`	PRIMARY	4	56
5	INDEX	`test`.`t1`	k	8	136
6	INDEX	`test`.`t1`	PRIMARY	1	4057
9	INDEX	`test`.`t1`	PRIMARY	3	12171
CALL iterate_pages_in_space();
Space size of test/t1:	space_size
Space size of test/t1:	11
@@innodb_dbug_gpp_no
0
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	1
@@innodb_dbug_gpp_no
1
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	2
@@innodb_dbug_gpp_no
2
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	3
@@innodb_dbug_gpp_no
3
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	4
@@innodb_dbug_gpp_no
4
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	5
@@innodb_dbug_gpp_no
5
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	6
@@innodb_dbug_gpp_no
6
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	7
@@innodb_dbug_gpp_no
7
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	8
@@innodb_dbug_gpp_no
8
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	8
@@innodb_dbug_gpp_no
9
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	9
@@innodb_dbug_gpp_no
10
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	10
@@innodb_dbug_gpp_no
11
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	11
@@innodb_dbug_gpp_no
12
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	12
@@innodb_dbug_gpp_no
13
id	c
4	4
Variable_name	Value
Lizard_index_scan_guess_clust_hit	1
Lizard_index_scan_guess_clust_miss	13

# Set gpp_no to a large number which is out of tablespace.
SET DEBUG='+d,set_gpp_enum_page_in_space';
SET GLOBAL innodb_dbug_gpp_no = 999999;
SELECT @@innodb_dbug_gpp_no;
@@innodb_dbug_gpp_no
999999
SET DEBUG_SYNC = 'gpp_ignore_missing_before_free_page SIGNAL s1 WAIT_FOR s2';
SELECT id, k FROM t1 WHERE k = 8;;
SET DEBUG='+d,set_gpp_enum_page_in_space';
SET DEBUG_SYNC = 'now WAIT_FOR s1';
SET DEBUG_SYNC = 'gpp_hit_io_fix_read SIGNAL s2';
SELECT id, k FROM t1 WHERE k = 8;
id	k
8	8
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	2
id	k
8	8
SET DEBUG='+d,set_gpp_enum_page_in_space';
SET GLOBAL innodb_dbug_gpp_no = 999999;
SELECT @@innodb_dbug_gpp_no;
@@innodb_dbug_gpp_no
999999
SET DEBUG_SYNC = 'gpp_ignore_missing_after_free_page SIGNAL s1 WAIT_FOR s2';
SELECT id, k FROM t1 WHERE k = 8;;
SET DEBUG='+d,set_gpp_enum_page_in_space';
SET DEBUG_SYNC = 'now WAIT_FOR s1';
SELECT id, k FROM t1 WHERE k = 8;
id	k
8	8
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	3
SET DEBUG_SYNC = 'now signal s2';
show status like '%scan_guess%';
Variable_name	Value
Lizard_index_scan_guess_clust_hit	0
Lizard_index_scan_guess_clust_miss	4
id	k
8	8
drop table t1;
set global innodb_lizard_stat_enabled = default;
set global innodb_purge_stop_now = default;
set global innodb_purge_run_now = default;
set global innodb_dbug_gpp_no = default;
drop procedure iterate_pages_in_space;
# Kill and restart
